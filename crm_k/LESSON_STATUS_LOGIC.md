# Логика статусов занятий

## Обновленная система статусов

Система статусов занятий была обновлена согласно новым требованиям. Теперь используются следующие статусы:

### Статусы занятий

1. **Запланировано** (`scheduled`)
   - Автоматически попадает в календарь
   - Если внесена полная предоплата → автоматически становится "Предоплачено"

2. **Предоплачено** (`prepaid`)
   - Ученик внёс оплату за занятие (100%)
   - Если занятие проведено → автоматически становится "Проведено" (доход)
   - При отмене работает по правилам отмены

3. **Отменено** (`cancelled`)
   - Может поставить админ или пользователь
   - Работает по правилам отмены

4. **Проведено** (`completed`)
   - Если проведено и была предоплата → автоматически статус становится "Проведено"
   - Если проведено без оплаты → автоматически статус становится "Задолженность"
   - Статус может быть изменён админом вручную

5. **Задолженность** (`debt`)
   - Урок проведён, но не оплачен
   - У ученика появляется долг в денежном выражении
   - Ставится автоматически или вручную админом

6. **Не оплачено** (`unpaid`)
   - Урок забронирован, но ещё не оплачен
   - Если урок состоялся и оплаты нет → автоматически переходит в "Задолженность"

## Схема переходов статусов

```
Запланировано → Предоплачено (при внесении оплаты)
Запланировано → Отменено (при отмене)
Запланировано → Проведено (при проведении урока)
Предоплачено → Проведено → Проведено (Авто)
Предоплачено → Отменено (по правилам отмены)
Проведено → Задолженность (если нет оплаты)
Не оплачено → Задолженность (после проведения)
```

## Правила отмены

- **Отмена за 5+ часов** → сумма возвращается в баланс ученика (предоплата)
- **Отмена менее чем за 5 часов** → сумма уходит в доход, возврат невозможен

## Техническая реализация

### Утилиты для работы со статусами

Создан файл `src/lib/lessonStatusUtils.ts` с функциями:

- `getLessonStatus(lesson)` - определяет статус занятия
- `getLessonStatusText(status)` - получает текстовое описание статуса
- `canCancelWithRefund(lessonDate)` - проверяет возможность отмены с возвратом
- `getCancellationResult(lesson)` - определяет результат отмены
- `getStatusAfterCompletion(lesson)` - определяет статус после проведения
- `getStatusAfterPayment(lesson)` - определяет статус после оплаты
- `validateStatusTransition()` - валидирует переходы между статусами

### Обновленные компоненты

- Календарь (`Calendar.tsx`, `MobileCalendar.tsx`, `DayLessonsModal.tsx`)
- Админ панель (`RecentActivity.tsx`, `LessonsManagement.tsx`)
- API endpoints для занятий и финансов

### Цветовая схема

- **Запланировано**: синий (`bg-blue-100`)
- **Предоплачено**: жёлтый (`bg-yellow-100`)
- **Отменено**: красный (`bg-red-100`)
- **Проведено**: зелёный (`bg-green-100`)
- **Задолженность**: оранжевый (`bg-orange-100`)
- **Не оплачено**: серый (`bg-gray-100`)

## Автоматическое обновление статусов

Система автоматически обновляет статусы прошедших занятий:

1. **Запланированные занятия** (не проведены и не оплачены) → **Задолженность**
2. **Предоплаченные занятия** (не проведены, но оплачены) → **Проведено**

Это происходит через API endpoint `/api/lessons/auto-update-status`.

## Финансовая логика

- **Доход** формируется только из занятий со статусом "Проведено" (проведены + оплачены)
- **Задолженности** учитываются отдельно для контроля неплатежей
- **Предоплаты** учитываются как баланс ученика до проведения занятия
