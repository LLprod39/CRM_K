# Документация по функционалу баланса учеников

## Обзор

Добавлен функционал для отслеживания баланса каждого ученика, включающий предоплату и задолженности. Администратор теперь может видеть, кто ведет каждый урок.

## Новые функции

### 1. Баланс учеников

#### Что это такое
- **Баланс** = Предоплата - Задолженность
- **Предоплата** - сумма за оплаченные, но не проведенные уроки
- **Задолженность** - сумма за проведенные, но не оплаченные уроки

#### Где отображается
- В списке учеников в админ панели (вкладка "Ученики")
- В детальном модальном окне баланса ученика
- Цветовая индикация: зеленый для положительного баланса, красный для отрицательного

#### Как работает
- Баланс автоматически обновляется при создании платежей
- Можно вручную корректировать баланс через админ панель
- Доступна история всех платежей

### 2. Отображение преподавателя

#### Что изменилось
- В админ панели (вкладка "Уроки") теперь отображается преподаватель для каждого урока
- Преподаватель берется из поля `teacherId` урока, а не из владельца ученика

#### Где отображается
- В списке уроков в админ панели
- Рядом с именем ученика и информацией об уроке

## Технические детали

### База данных

#### Обновления схемы
```sql
-- Добавлено поле balance в таблицу students
ALTER TABLE students ADD COLUMN balance REAL DEFAULT 0;
```

#### Новые API endpoints
- `GET /api/students/[id]/balance` - получить информацию о балансе ученика
- `PUT /api/students/[id]/balance` - обновить баланс ученика (только для админов)
- `POST /api/admin/sync-balances` - синхронизировать балансы всех учеников

### Компоненты

#### StudentBalanceCard
- Отображает детальную информацию о балансе ученика
- Показывает предоплату, задолженность и общий баланс
- Включает историю платежей
- Позволяет быстро корректировать баланс (+1000/-1000 ₸)

#### Обновленный StudentAssignment
- Добавлено отображение баланса в списке учеников
- Добавлена кнопка "Баланс" для просмотра детальной информации
- Модальное окно с компонентом StudentBalanceCard

#### Обновленный LessonsManagement
- Исправлено отображение преподавателя (теперь берется из teacherId)
- Добавлена информация о преподавателе в список уроков

### Утилиты

#### balanceUtils.ts
- `updateStudentBalance()` - обновляет баланс конкретного ученика
- `updateAllStudentBalances()` - обновляет балансы всех учеников
- `getStudentBalanceInfo()` - получает детальную информацию о балансе

#### sync-student-balances.js
- Скрипт для синхронизации балансов всех учеников
- Можно запускать вручную: `node scripts/sync-student-balances.js`

## Логика расчета баланса

### Предоплата
Уроки, которые:
- Оплачены (`isPaid = true`)
- Не проведены (`isCompleted = false`)
- Не отменены (`isCancelled = false`)

### Задолженность
Уроки, которые:
- Проведены (`isCompleted = true`)
- Не оплачены (`isPaid = false`)
- Не отменены (`isCancelled = false`)

### Автоматическое обновление
Баланс автоматически обновляется при:
- Создании нового платежа (увеличивается на сумму платежа)
- Изменении статуса урока (проведение, оплата, отмена)

## Права доступа

### Администратор
- Может просматривать балансы всех учеников
- Может корректировать балансы вручную
- Может синхронизировать балансы всех учеников

### Учитель
- Может просматривать балансы только своих учеников
- Не может корректировать балансы

## Использование

### Просмотр баланса ученика
1. Перейти в админ панель → вкладка "Ученики"
2. Найти нужного ученика в списке
3. Нажать кнопку "Баланс"
4. В модальном окне просмотреть детальную информацию

### Корректировка баланса
1. Открыть модальное окно баланса ученика
2. Использовать кнопки "+1000 ₸" или "-1000 ₸"
3. Или использовать API endpoint для точной корректировки

### Синхронизация балансов
1. Запустить скрипт: `node scripts/sync-student-balances.js`
2. Или использовать API endpoint: `POST /api/admin/sync-balances`

## Примеры

### Положительный баланс (предоплата)
```
Ученик: Иванов Иван Иванович
Баланс: +15,000 ₸
Предоплата: 15,000 ₸ (3 урока)
Задолженность: 0 ₸
```

### Отрицательный баланс (задолженность)
```
Ученик: Петров Петр Петрович
Баланс: -5,000 ₸
Предоплата: 0 ₸
Задолженность: 5,000 ₸ (2 урока)
```

### Нулевой баланс
```
Ученик: Сидоров Сидор Сидорович
Баланс: 0 ₸
Предоплата: 0 ₸
Задолженность: 0 ₸
```
