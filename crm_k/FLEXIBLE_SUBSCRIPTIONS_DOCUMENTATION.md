# Документация: Гибкие абонементы

## Обзор

Реализован новый функционал **гибких абонементов**, который позволяет создавать абонементы с разными днями недели и временем для каждой недели. Это решает задачу создания абонементов, где одна неделя может быть понедельник-вторник, а другая среда-четверг, с разным временем для каждого дня.

## Основные возможности

### 1. Гибкое расписание
- ✅ Разные дни недели для каждой недели абонемента
- ✅ Разное время для каждого дня
- ✅ Разная стоимость для каждого занятия
- ✅ Разные места проведения (офис, онлайн, на дому)
- ✅ Индивидуальные заметки для каждого дня

### 2. Управление абонементами
- ✅ Создание абонементов с множественными неделями
- ✅ Просмотр всех абонементов с детальным расписанием
- ✅ Генерация уроков из абонемента
- ✅ Система платежей по абонементам
- ✅ Автоматический расчет общей стоимости

### 3. Интеграция с существующей системой
- ✅ Интеграция с формами добавления учеников
- ✅ Интеграция с формами добавления уроков
- ✅ Совместимость с существующей системой платежей
- ✅ Проверка конфликтов времени при генерации уроков

## Структура данных

### Модели базы данных

#### FlexibleSubscription
- `id` - уникальный идентификатор
- `name` - название абонемента
- `studentId` - ID ученика
- `userId` - ID преподавателя
- `startDate` - дата начала абонемента
- `endDate` - дата окончания абонемента
- `totalCost` - общая стоимость
- `isPaid` - статус оплаты
- `description` - описание

#### FlexibleSubscriptionWeek
- `id` - уникальный идентификатор
- `subscriptionId` - ID абонемента
- `weekNumber` - номер недели (1, 2, 3...)
- `startDate` - дата начала недели
- `endDate` - дата окончания недели

#### FlexibleSubscriptionDay
- `id` - уникальный идентификатор
- `weekId` - ID недели
- `dayOfWeek` - день недели (0=воскресенье, 1=понедельник...)
- `startTime` - время начала занятия
- `endTime` - время окончания занятия
- `cost` - стоимость занятия
- `location` - место проведения
- `notes` - заметки

#### FlexibleSubscriptionPayment
- `id` - уникальный идентификатор
- `subscriptionId` - ID абонемента
- `amount` - сумма платежа
- `date` - дата платежа
- `description` - описание платежа

## API Endpoints

### Основные операции
- `GET /api/flexible-subscriptions` - получить все абонементы
- `POST /api/flexible-subscriptions` - создать новый абонемент
- `GET /api/flexible-subscriptions/[id]` - получить конкретный абонемент
- `PUT /api/flexible-subscriptions/[id]` - обновить абонемент
- `DELETE /api/flexible-subscriptions/[id]` - удалить абонемент

### Дополнительные операции
- `POST /api/flexible-subscriptions/[id]/generate-lessons` - сгенерировать уроки
- `GET /api/flexible-subscriptions/[id]/payments` - получить платежи
- `POST /api/flexible-subscriptions/[id]/payments` - добавить платеж

## Интерфейс пользователя

### Страница управления абонементами
- **URL**: `/flexible-subscriptions`
- **Доступ**: Только администраторы
- **Функции**:
  - Просмотр всех абонементов
  - Создание новых абонементов
  - Генерация уроков из абонементов

### Форма создания абонемента
- **Компонент**: `FlexibleSubscriptionForm`
- **Функции**:
  - Выбор ученика и преподавателя
  - Настройка периода абонемента
  - Добавление недель с индивидуальным расписанием
  - Автоматический расчет стоимости

### Интеграция в существующие формы
- **Форма добавления ученика**: кнопка "Гибкий абонемент"
- **Форма добавления урока**: кнопка "Создать гибкий абонемент"

## Примеры использования

### Пример 1: Абонемент с чередующимися днями
```
Неделя 1: Понедельник 10:00-11:00, Вторник 14:00-15:00
Неделя 2: Среда 10:00-11:00, Четверг 14:00-15:00
Неделя 3: Пятница 10:00-11:00, Суббота 12:00-13:00
```

### Пример 2: Абонемент с разной стоимостью
```
Понедельник: 1000₸ (офис)
Вторник: 1200₸ (на дому)
Среда: 800₸ (онлайн)
```

## Безопасность и права доступа

- **Доступ к странице абонементов**: только администраторы
- **Создание абонементов**: только администраторы
- **Просмотр абонементов**: только администраторы
- **Генерация уроков**: только администраторы
- **Управление платежами**: только администраторы
- **Навигация**: вкладка "Абонементы" отображается только для администраторов

## Технические детали

### Валидация
- Проверка обязательных полей
- Валидация дат (начало < окончание)
- Проверка корректности времени
- Проверка стоимости (больше 0)

### Проверка конфликтов
- При генерации уроков проверяются конфликты времени
- Учитываются существующие уроки и время обеда
- Отчет о конфликтах с деталями

### Производительность
- Оптимизированные запросы к базе данных
- Каскадное удаление связанных записей
- Индексы для быстрого поиска

## Будущие улучшения

- [ ] Шаблоны абонементов для быстрого создания
- [ ] Массовое создание абонементов
- [ ] Экспорт расписания в календарь
- [ ] Уведомления о предстоящих занятиях
- [ ] Статистика по абонементам
