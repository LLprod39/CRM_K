# Система назначения учеников для администраторов

## Обзор изменений

Реализована полная система управления назначениями учеников учителям для администраторов системы CRM_K.

## Ключевые особенности

### 1. Ограничения для администраторов

✅ **Администраторы не могут иметь назначенных учеников**
- API `/api/students/assign` блокирует назначение учеников админам
- Существующие назначения у админов автоматически удалены

✅ **Администраторы не могут создавать занятия для себя**
- API `/api/lessons` блокирует создание занятий на админа
- Валидация требует выбора учителя для создания занятия

✅ **Автоматическое перенаправление**
- Админы автоматически перенаправляются в админскую панель при попытке доступа к обычным страницам
- Страницы `/students`, `/schedule`, и главная `/` перенаправляют админа в `/admin`

### 2. Возможности администраторов

✅ **Назначение любого ученика любому учителю**
- Интерфейс `StudentAssignment` в админской панели
- Возможность отменить назначение и сделать ученика "нечейным"

✅ **Создание занятий для любого учителя с любым учеником**
- Форма `AddLessonForm` позволяет админу:
  - Выбрать любого учителя из списка (через `UserSelector`)
  - Выбрать любого ученика из всего списка (через `StudentSearch`)
  - Создать индивидуальные или групповые занятия
  - **НОВОЕ**: Админ может назначать занятия с любыми учениками любому учителю
  - **НОВОЕ**: При создании занятия ученик автоматически назначается выбранному учителю

✅ **Полный обзор системы**
- Админ видит всех учеников и все занятия в системе
- Статистика по всем пользователям и ученикам
- Управление пользователями, игрушками, настройками

## Технические детали

### API Endpoints

#### `/api/students/assign` (POST)
- Назначение ученика учителю
- Блокирует назначение админам
- Только для администраторов

#### `/api/students/assign` (DELETE)
- Отмена назначения ученика
- Делает ученика "нечейным"
- Только для администраторов

#### `/api/lessons` (POST)
- Создание занятий
- Для админов требует выбор учителя (`userId`)
- Блокирует создание занятий на админа
- **ОБНОВЛЕНО**: Админ может назначать занятия с любыми учениками любому учителю
- **ОБНОВЛЕНО**: При создании занятия все выбранные ученики автоматически назначаются выбранному учителю

#### `/api/lessons/bulk` (POST)
- Создание массовых занятий
- Только для администраторов
- **ОБНОВЛЕНО**: Админ может создавать массовые занятия с любыми учениками любому учителю
- **ОБНОВЛЕНО**: При создании массовых занятий все выбранные ученики автоматически назначаются выбранному учителю

#### `/api/admin/teachers` (GET)
- Получение списка учителей (пользователей с ролью USER)
- Исключает администраторов
- Включает статистику по количеству учеников

### Компоненты

#### `StudentAssignment`
```
/admin -> вкладка "Ученики"
- Список всех учеников с статусом назначения
- Выбор учителя для назначения
- Отмена назначения
- Фильтрация и поиск
```

#### `AddLessonForm` (обновлен)
```
Для админов:
- UserSelector: выбор любого учителя
- StudentSearch: выбор любого ученика (без ограничений)
- Валидация требует выбора и учителя и ученика
```

#### `LessonsManagement`
```
/admin -> вкладка "Занятия" 
- Просмотр всех занятий в системе
- Создание, редактирование, удаление
- Фильтрация по различным параметрам
```

### Схема базы данных

Используется существующая схема:
```sql
Student {
  userId: Int? (nullable - для "нечейных" учеников)
  isAssigned: Boolean (флаг назначения)
  user: User? (связь с учителем)
}

User {
  role: UserRole (ADMIN | USER)
  students: Student[] (назначенные ученики)
}
```

## Workflow для администратора

### 1. Создание и назначение ученика
```
1. /admin -> "Ученики" -> "Добавить ученика"
2. Ученик создается как "нечейный" (userId = null)
3. В списке учеников выбрать учителя из dropdown
4. Ученик назначается выбранному учителю
```

### 2. Создание занятия
```
1. /admin -> "Занятия" -> "Добавить занятие"
2. Выбрать учителя из UserSelector
3. Выбрать любого ученика из списка (включая уже назначенных другим учителям)
4. Указать время, стоимость и другие параметры
5. **НОВОЕ**: Все выбранные ученики автоматически назначаются выбранному учителю
6. Ученик появляется в списке учеников выбранного учителя
```

### 3. Управление назначениями
```
1. /admin -> "Ученики"
2. Просмотр всех учеников с их статусом
3. Фильтрация: "Все" | "Назначенные" | "Не назначенные"
4. Изменение назначений через dropdown
5. Отмена назначения кнопкой "Отменить назначение"
```

## Безопасность

- ✅ API защищен от назначения учеников админам
- ✅ API защищен от создания занятий на админов  
- ✅ Автоматическое перенаправление админов в панель управления
- ✅ Валидация форм предотвращает некорректные действия
- ✅ Роль пользователя проверяется на каждом API запросе

## Тестирование

Запустите скрипт проверки:
```bash
node scripts/test-admin-restrictions.js
```

Скрипт проверяет:
- Отсутствие назначенных учеников у админов
- Отсутствие занятий у учеников админов
- Корректность общей статистики системы

## Совместимость

- ✅ Все существующие функции для обычных пользователей работают без изменений
- ✅ Существующие ученики и занятия не затронуты (кроме удаления назначений у админов)
- ✅ Миграции и схема БД остались совместимыми

## Последние обновления

### Расширенные возможности назначения занятий (2024)

**Проблема**: Ранее админ не мог назначать занятия с учениками, которые уже принадлежали другим учителям или не были "нечейными".

**Решение**: 
- ✅ Убрана проверка принадлежности учеников для админов в API `/api/lessons` и `/api/lessons/bulk`
- ✅ Админ теперь может назначать занятия с любыми учениками любому учителю
- ✅ При создании занятия все выбранные ученики автоматически назначаются выбранному учителю
- ✅ Ученик появляется в списке учеников выбранного учителя в разделе "Ученики"

**Результат**: Админ получил полную гибкость в управлении назначениями и может легко перераспределять учеников между учителями через создание занятий.

### Исправление проблемы с переносом доходов (2024)

**Проблема**: При автоматическом назначении ученика новому учителю все его предыдущие занятия и доходы тоже переходили к новому учителю.

**Решение**: 
- ✅ Добавлено поле `teacherId` в модель `Lesson` для фиксации учителя, проводившего занятие
- ✅ Обновлена логика расчета доходов для использования `teacherId` вместо `student.userId`
- ✅ Создана миграция для обновления существующих данных
- ✅ Доходы теперь остаются за тем учителем, который проводил занятия

**Результат**: Проблема с переносом доходов полностью решена. Теперь доходы зафиксированы за тем учителем, который проводил занятия, независимо от текущего назначения ученика.

### Исправление проблемы с переносом учеников и занятий (2024)

**Проблема**: После предыдущих изменений возникла новая проблема - ученики оставались только у последнего учителя, все занятия "переходили" к одному учителю, в расписании показывались только занятия последнего учителя.

**Решение**: 
- ✅ Убрано автоматическое назначение ученика учителю при создании занятия
- ✅ Обновлена логика получения учеников - показывать всех, кто проводил с ними занятия
- ✅ Обновлена логика расписания и календаря - показывать все занятия пользователя
- ✅ Обновлены API проверки доступа для использования `teacherId`

**Результат**: Теперь ученики остаются у всех учителей, которые проводили с ними занятия. Каждый учитель видит своих учеников и свои занятия. Занятия не "переходят" к одному учителю. Доходы остаются корректными.

### Исправление логики доступа к абонементам и предоплатам (2024)

**Проблема**: Пользователи видели только абонементы, которые им принадлежали, и только предоплаты для своих учеников.

**Решение**: 
- ✅ Обновлена логика получения абонементов - показывать для учеников, с которыми проводил занятия
- ✅ Логика получения предоплат уже была правильной
- ✅ Логика создания абонементов и предоплат уже была правильной

**Результат**: Пользователи видят абонементы и предоплаты для всех учеников, с которыми проводили занятия. Админ может создавать абонементы с любыми учениками для любого пользователя.

### Исправление логики выбора учеников в формах создания абонементов (2024)

**Проблема**: В формах создания абонементов пользователи могли выбрать только учеников, которые им принадлежали.

**Решение**: 
- ✅ Исправлена фильтрация учеников в SubscriptionModal.tsx
- ✅ Исправлена фильтрация учеников в UnifiedSubscriptionModal.tsx
- ✅ FlexibleSubscriptionForm.tsx уже был правильным

**Результат**: Админ может выбрать любого ученика при создании абонемента для любого пользователя. Формы создания абонементов работают корректно для всех типов абонементов.

**Решение**: 
- ✅ Обновлена логика получения абонементов - показывать для учеников, с которыми проводил занятия
- ✅ Логика получения предоплат уже была правильной
- ✅ Логика создания абонементов и предоплат уже была правильной

**Результат**: Теперь пользователи видят абонементы и предоплаты для всех учеников, с которыми проводили занятия. Админ может создавать абонементы с любыми учениками для любого пользователя, и пользователь получает доступ к этим абонементам.

## Заключение

Система полностью реализует требование: "Админ может присваивать любого ученика любому учителю/пользователю, а на админе не должно быть присвоенных учеников и занятий."

Администратор теперь выступает в роли координатора, который:
1. Управляет назначениями учеников учителям
2. Создает занятия от имени учителей с любыми учениками
3. Имеет полный обзор системы без личных назначений
4. Не может случайно назначить себе учеников или занятия
5. **НОВОЕ**: Может легко перераспределять учеников между учителями через создание занятий
