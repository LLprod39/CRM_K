# Система назначения учеников для администраторов

## Обзор изменений

Реализована полная система управления назначениями учеников учителям для администраторов системы CRM_K.

## Ключевые особенности

### 1. Ограничения для администраторов

✅ **Администраторы не могут иметь назначенных учеников**
- API `/api/students/assign` блокирует назначение учеников админам
- Существующие назначения у админов автоматически удалены

✅ **Администраторы не могут создавать занятия для себя**
- API `/api/lessons` блокирует создание занятий на админа
- Валидация требует выбора учителя для создания занятия

✅ **Автоматическое перенаправление**
- Админы автоматически перенаправляются в админскую панель при попытке доступа к обычным страницам
- Страницы `/students`, `/schedule`, и главная `/` перенаправляют админа в `/admin`

### 2. Возможности администраторов

✅ **Назначение любого ученика любому учителю**
- Интерфейс `StudentAssignment` в админской панели
- Возможность отменить назначение и сделать ученика "нечейным"

✅ **Создание занятий для любого учителя с любым учеником**
- Форма `AddLessonForm` позволяет админу:
  - Выбрать любого учителя из списка (через `UserSelector`)
  - Выбрать любого ученика из всего списка (через `StudentSearch`)
  - Создать индивидуальные или групповые занятия

✅ **Полный обзор системы**
- Админ видит всех учеников и все занятия в системе
- Статистика по всем пользователям и ученикам
- Управление пользователями, игрушками, настройками

## Технические детали

### API Endpoints

#### `/api/students/assign` (POST)
- Назначение ученика учителю
- Блокирует назначение админам
- Только для администраторов

#### `/api/students/assign` (DELETE)
- Отмена назначения ученика
- Делает ученика "нечейным"
- Только для администраторов

#### `/api/lessons` (POST)
- Создание занятий
- Для админов требует выбор учителя (`userId`)
- Блокирует создание занятий на админа
- Автоматически назначает "нечейных" учеников выбранному учителю

#### `/api/admin/teachers` (GET)
- Получение списка учителей (пользователей с ролью USER)
- Исключает администраторов
- Включает статистику по количеству учеников

### Компоненты

#### `StudentAssignment`
```
/admin -> вкладка "Ученики"
- Список всех учеников с статусом назначения
- Выбор учителя для назначения
- Отмена назначения
- Фильтрация и поиск
```

#### `AddLessonForm` (обновлен)
```
Для админов:
- UserSelector: выбор любого учителя
- StudentSearch: выбор любого ученика (без ограничений)
- Валидация требует выбора и учителя и ученика
```

#### `LessonsManagement`
```
/admin -> вкладка "Занятия" 
- Просмотр всех занятий в системе
- Создание, редактирование, удаление
- Фильтрация по различным параметрам
```

### Схема базы данных

Используется существующая схема:
```sql
Student {
  userId: Int? (nullable - для "нечейных" учеников)
  isAssigned: Boolean (флаг назначения)
  user: User? (связь с учителем)
}

User {
  role: UserRole (ADMIN | USER)
  students: Student[] (назначенные ученики)
}
```

## Workflow для администратора

### 1. Создание и назначение ученика
```
1. /admin -> "Ученики" -> "Добавить ученика"
2. Ученик создается как "нечейный" (userId = null)
3. В списке учеников выбрать учителя из dropdown
4. Ученик назначается выбранному учителю
```

### 2. Создание занятия
```
1. /admin -> "Занятия" -> "Добавить занятие"
2. Выбрать учителя из UserSelector
3. Выбрать любого ученика из списка
4. Указать время, стоимость и другие параметры
5. Если ученик был "нечейным", он автоматически назначается выбранному учителю
```

### 3. Управление назначениями
```
1. /admin -> "Ученики"
2. Просмотр всех учеников с их статусом
3. Фильтрация: "Все" | "Назначенные" | "Не назначенные"
4. Изменение назначений через dropdown
5. Отмена назначения кнопкой "Отменить назначение"
```

## Безопасность

- ✅ API защищен от назначения учеников админам
- ✅ API защищен от создания занятий на админов  
- ✅ Автоматическое перенаправление админов в панель управления
- ✅ Валидация форм предотвращает некорректные действия
- ✅ Роль пользователя проверяется на каждом API запросе

## Тестирование

Запустите скрипт проверки:
```bash
node scripts/test-admin-restrictions.js
```

Скрипт проверяет:
- Отсутствие назначенных учеников у админов
- Отсутствие занятий у учеников админов
- Корректность общей статистики системы

## Совместимость

- ✅ Все существующие функции для обычных пользователей работают без изменений
- ✅ Существующие ученики и занятия не затронуты (кроме удаления назначений у админов)
- ✅ Миграции и схема БД остались совместимыми

## Заключение

Система полностью реализует требование: "Админ может присваивать любого ученика любому учителю/пользователю, а на админе не должно быть присвоенных учеников и занятий."

Администратор теперь выступает в роли координатора, который:
1. Управляет назначениями учеников учителям
2. Создает занятия от имени учителей  
3. Имеет полный обзор системы без личных назначений
4. Не может случайно назначить себе учеников или занятия
