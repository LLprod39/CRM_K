# Руководство по функционалу платежей

## Обзор

Добавлен полноценный функционал для управления платежами в CRM системе. Пользователи могут добавлять платежи, связывать их с конкретными уроками и просматривать историю платежей.

## Новые возможности

### 1. Добавление платежей

- **Кнопка "Добавить платеж"** на странице финансов
- **Выбор ученика** из выпадающего списка
- **Автоматическая загрузка неоплаченных уроков** при выборе ученика
- **Выбор конкретных уроков** для оплаты (опционально)
- **Автоматический расчет суммы** на основе выбранных уроков
- **Указание даты и описания** платежа

### 2. Управление уроками

- **Автоматическое изменение статуса** выбранных уроков на "Оплачено"
- **Связь платежей с уроками** через промежуточную таблицу
- **Отображение неоплаченных уроков** с возможностью выбора

### 3. История платежей

- **Компонент PaymentsList** для отображения всех платежей
- **Детальная информация** о каждом платеже
- **Связь с уроками** - можно посмотреть, за какие уроки был произведен платеж
- **Фильтрация по ученику** (опционально)

## Технические детали

### API Endpoints

1. **GET /api/payments** - получение списка платежей
   - Параметры: `studentId` (опционально)
   - Возвращает: массив платежей с информацией об учениках и уроках

2. **POST /api/payments** - создание нового платежа
   - Тело запроса: `CreatePaymentData`
   - Автоматически обновляет статус связанных уроков

3. **GET /api/payments/unpaid-lessons** - получение неоплаченных уроков ученика
   - Параметры: `studentId` (обязательно)
   - Возвращает: список неоплаченных уроков и общую сумму задолженности

### База данных

#### Новая таблица `payments`
```sql
- id: Int (PK)
- studentId: Int (FK)
- amount: Float
- date: DateTime
- description: String?
- createdAt: DateTime
- updatedAt: DateTime
```

#### Новая таблица `payment_lessons`
```sql
- id: Int (PK)
- paymentId: Int (FK)
- lessonId: Int (FK)
- unique(paymentId, lessonId)
```

### Компоненты

1. **AddPaymentForm** - форма добавления платежа
2. **PaymentsList** - список истории платежей
3. **Обновленная страница финансов** с интеграцией новых компонентов

## Использование

### Добавление платежа

1. Перейдите на страницу "Финансы"
2. Нажмите кнопку "Добавить платеж"
3. Выберите ученика из выпадающего списка
4. Система автоматически загрузит неоплаченные уроки
5. Выберите уроки для оплаты (опционально)
6. Укажите сумму платежа (автоматически заполняется суммой выбранных уроков)
7. Выберите дату платежа
8. Добавьте описание (опционально)
9. Нажмите "Создать платеж"

### Просмотр истории платежей

- История платежей отображается в правой колонке на странице финансов
- Можно развернуть детали каждого платежа
- Показаны связанные уроки для каждого платежа

## Безопасность

- Все API endpoints защищены аутентификацией
- Пользователи видят только своих учеников (кроме админов)
- Валидация данных на сервере и клиенте
- Транзакции для обеспечения целостности данных

## Уведомления

- Используется система Toast для уведомлений
- Успешные операции отображаются зеленым цветом
- Ошибки отображаются красным цветом
- Автоматическое обновление данных после добавления платежа
