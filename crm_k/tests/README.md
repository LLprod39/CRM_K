# Тесты CRM платформы

Комплексный набор тестов для проверки всех возможностей логики работы платформы CRM для детского сада.

## Структура тестов

```
tests/
├── unit/                    # Модульные тесты
│   └── auth.test.js        # Тесты аутентификации
├── integration/             # Интеграционные тесты
│   ├── auth-api.test.js    # API аутентификации
│   ├── students.test.js    # Управление студентами
│   ├── lessons.test.js     # Управление занятиями
│   ├── payments.test.js    # Платежи
│   ├── finances.test.js    # Финансовая логика
│   ├── lunch-breaks.test.js # Время обеда
│   ├── users.test.js       # Управление пользователями
│   └── workflow.test.js    # Полные рабочие процессы
├── e2e/                     # End-to-End тесты
│   └── app.test.js         # Полные сценарии приложения
├── fixtures/                # Тестовые данные
│   └── testData.js         # Фикстуры для тестов
├── utils/                   # Утилиты для тестов
│   └── testHelpers.js      # Вспомогательные функции
├── setup.js                 # Настройка тестового окружения
├── jest.config.js          # Конфигурация Jest
└── package.json            # Зависимости для тестов
```

## Покрытие функциональности

### ✅ Аутентификация и авторизация
- Верификация JWT токенов
- Логин/логаут
- Роли пользователей (ADMIN/USER)
- Защита маршрутов
- Обработка ошибок аутентификации

### ✅ Управление студентами
- CRUD операции для студентов
- Валидация данных
- Изоляция данных между пользователями
- Связи с пользователями
- Каскадное удаление

### ✅ Управление занятиями
- Создание индивидуальных и групповых занятий
- Планирование расписания
- Проверка конфликтов времени
- Обновление статусов занятий
- Связи со студентами

### ✅ Платежи
- Создание платежей
- Связывание с занятиями
- Автоматическое обновление статуса оплаты
- Фильтрация по датам
- Валидация данных

### ✅ Финансовая логика
- Статистика доходов
- Расчет долгов
- Предоплаченные занятия
- Экспорт данных
- Фильтрация по периодам

### ✅ Время обеда
- Создание и обновление времени обеда
- Проверка конфликтов с занятиями
- Управление для разных пользователей
- Валидация времени

### ✅ Управление пользователями (Admin)
- CRUD операции для пользователей
- Статистика пользователей
- Каскадное удаление
- Валидация данных

### ✅ Интеграционные сценарии
- Полные рабочие процессы
- Изоляция данных между пользователями
- Согласованность данных
- Обработка ошибок

## Запуск тестов

### Установка зависимостей
```bash
cd tests
npm install
```

### Запуск всех тестов
```bash
npm test
```

### Запуск конкретных типов тестов
```bash
# Модульные тесты
npm run test:unit

# Интеграционные тесты
npm run test:integration

# End-to-End тесты
npm run test:e2e
```

### Запуск с покрытием кода
```bash
npm run test:coverage
```

### Режим наблюдения (для разработки)
```bash
npm run test:watch
```

### CI/CD режим
```bash
npm run test:ci
```

## Настройка тестового окружения

### Переменные окружения
```bash
# .env.test
JWT_SECRET=test-secret-key
DATABASE_URL=file:./test.db
```

### Тестовая база данных
Тесты используют отдельную SQLite базу данных (`test.db`) для изоляции от продакшн данных.

### Автоматическая очистка
Каждый тест автоматически очищает базу данных перед выполнением для обеспечения изоляции.

## Структура тестовых данных

### Фикстуры
- **Пользователи**: admin, user, user2
- **Студенты**: student1, student2, student3
- **Занятия**: individual, group, online
- **Платежи**: payment1, payment2, payment3
- **Время обеда**: lunch1, lunch2
- **Игрушки**: toy1, toy2, toy3
- **AI предложения**: suggestion1

### Вспомогательные функции
- `createTestUser()` - создание тестового пользователя
- `createTestStudent()` - создание тестового студента
- `createTestLesson()` - создание тестового занятия
- `createTestPayment()` - создание тестового платежа
- `createTestLunchBreak()` - создание тестового времени обеда

## Проверяемые сценарии

### 1. Полный жизненный цикл студента
- Создание студента
- Добавление занятий
- Отметка о проведении
- Создание платежей
- Обновление информации
- Удаление с каскадом

### 2. Управление расписанием
- Создание времени обеда
- Планирование занятий
- Проверка конфликтов
- Обновление расписания

### 3. Финансовые процессы
- Создание занятий разных статусов
- Обработка платежей
- Расчет статистики
- Экспорт данных

### 4. Административные функции
- Создание пользователей
- Управление ролями
- Просмотр статистики
- Удаление пользователей

### 5. Изоляция данных
- Проверка доступа между пользователями
- Админские права
- Защита от несанкционированного доступа

## Обработка ошибок

Тесты проверяют:
- Валидацию входных данных
- Обработку несуществующих ресурсов
- Несанкционированный доступ
- Конфликты данных
- Сетевые ошибки

## Покрытие кода

Тесты обеспечивают покрытие:
- Всех API endpoints
- Бизнес-логики
- Валидации данных
- Обработки ошибок
- Интеграций между компонентами

## CI/CD интеграция

Тесты готовы для интеграции с:
- GitHub Actions
- GitLab CI
- Jenkins
- Другими системами CI/CD

Команда `npm run test:ci` оптимизирована для CI окружения.
