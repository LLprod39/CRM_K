# Исправление ошибки при создании обычных абонементов

## Проблема

При создании обычного абонемента с предоплатой возникала ошибка:
```
Ошибка при создании абонемента
В указанном периоде нет неоплаченных занятий
```

## Анализ проблемы

Ошибка происходила из-за неправильной последовательности создания занятий и предоплаты:

1. **Проблемный код в `UnifiedSubscriptionModal.tsx` (строка 1368):**
   ```typescript
   isPaid: regularData.paymentStatus === 'PAID', // Синхронизируем с paymentStatus
   ```

2. **Что происходило:**
   - Когда пользователь выбирал `paymentStatus: 'PAID'`, занятия создавались сразу как оплаченные (`isPaid: true`)
   - Затем система пыталась создать предоплату, но не находила неоплаченных занятий
   - API `/api/payments/prepayment` возвращал ошибку "В указанном периоде нет неоплаченных занятий"

## Решение

### 1. Исправлена логика создания занятий

**Было:**
```typescript
isPaid: regularData.paymentStatus === 'PAID', // Синхронизируем с paymentStatus
paymentStatus: regularData.paymentStatus
```

**Стало:**
```typescript
isPaid: false, // Всегда создаем занятия как неоплаченные, предоплата их пометит как оплаченные
paymentStatus: 'UNPAID' // Изначально все занятия неоплачены
```

### 2. Добавлено условие для создания предоплаты

**Было:**
```typescript
// Создание предоплаты
const paymentData = { ... };
```

**Стало:**
```typescript
// Создание предоплаты только если пользователь указал, что абонемент оплачен
if (regularData.paymentStatus === 'PAID') {
  const paymentData = { ... };
  // ...
}
```

## Правильная последовательность работы

1. **Занятия создаются как неоплаченные** (`isPaid: false`, `paymentStatus: 'UNPAID'`)
2. **Если пользователь выбрал статус оплаты 'PAID'**, создается предоплата
3. **Предоплата автоматически помечает соответствующие занятия как оплаченные**

## Результат

Теперь создание абонементов работает корректно:
- ✅ При выборе статуса "Не оплачено" - создаются только занятия
- ✅ При выборе статуса "Оплачено" - создаются занятия + предоплата их помечает как оплаченные
- ✅ Нет конфликтов между статусом занятий и попыткой создания предоплаты

## Затронутые файлы

- `src/components/forms/UnifiedSubscriptionModal.tsx` - исправлена логика создания занятий и предоплаты

## Совместимость

Исправление не влияет на:
- Существующие занятия и абонементы
- Другие компоненты форм (`SubscriptionForm.tsx`, `SubscriptionModal.tsx`)
- Гибкие абонементы
- API для создания предоплат

Все изменения обратно совместимы и не требуют миграции данных.
