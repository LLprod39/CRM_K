# Исправление проблемы с переносом доходов при смене учителя

## Проблема

Ранее при автоматическом назначении ученика новому учителю все его предыдущие занятия и доходы тоже переходили к новому учителю, потому что занятия были связаны с учеником через `studentId`, а доход рассчитывался через связь `student.userId`.

## Решение

### 1. Добавлено поле `teacherId` в модель `Lesson`

```prisma
model Lesson {
  id          Int      @id @default(autoincrement())
  date        DateTime
  endTime     DateTime
  studentId   Int      // ID ученика
  teacherId   Int      // ID учителя, который проводил занятие
  cost        Float
  // ... остальные поля
  
  // Связь с учеником
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  // Связь с учителем
  teacher     User     @relation(fields: [teacherId], references: [id], onDelete: Cascade)
}
```

### 2. Обновлена модель `User`

```prisma
model User {
  // ... существующие поля
  
  // Связь с занятиями (занятия, которые проводил этот учитель)
  lessons   Lesson[]
}
```

### 3. Создана миграция

Миграция `20250912220732_add_teacher_id_to_lessons`:
- Добавляет поле `teacherId` в таблицу `lessons`
- Заполняет существующие занятия на основе `student.userId`
- Для "нечейных" учеников использует админа (id=1) как fallback

### 4. Обновлены API endpoints

#### Создание занятий
- `/api/lessons` (POST) - теперь сохраняет `teacherId`
- `/api/lessons/bulk` (POST) - теперь сохраняет `teacherId`

#### Расчет доходов
- `/api/finances/stats` - теперь использует `teacherId` вместо `student.userId`
- `/api/finances/debts` - теперь использует `teacherId`
- `/api/finances/chart` - теперь использует `teacherId`
- `/api/finances/students/[id]` - обновлена логика доступа
- `/api/admin/stats` - теперь считает занятия по `teacherId`

### 5. Логика работы

**До изменений:**
- Занятие связано только с учеником (`studentId`)
- Доход рассчитывается через `student.userId`
- При смене `student.userId` все доходы переходят к новому учителю

**После изменений:**
- Занятие связано и с учеником (`studentId`) и с учителем (`teacherId`)
- Доход рассчитывается через `lesson.teacherId`
- При смене `student.userId` доходы остаются у того учителя, который проводил занятия
- Админ может назначать занятия с любыми учениками любому учителю
- При создании занятия ученик автоматически назначается выбранному учителю

## Результат

✅ **Проблема решена**: Доходы теперь зафиксированы за тем учителем, который проводил занятия

✅ **Сохранена функциональность**: Админ по-прежнему может назначать занятия с любыми учениками любому учителю

✅ **Обратная совместимость**: Существующие данные сохранены и корректно обработаны

## Тестирование

Для проверки работы системы:

1. Создайте занятие с учеником у одного учителя
2. Отметьте занятие как проведенное и оплаченное
3. Назначьте ученика другому учителю через админа
4. Проверьте, что доход остался у первого учителя
5. Создайте новое занятие с тем же учеником у второго учителя
6. Проверьте, что новое занятие засчитывается второму учителю

## Файлы изменений

- `prisma/schema.prisma` - обновлена схема
- `prisma/migrations/20250912220732_add_teacher_id_to_lessons/migration.sql` - миграция
- `src/app/api/lessons/route.ts` - обновлено создание занятий
- `src/app/api/lessons/bulk/route.ts` - обновлено массовое создание занятий
- `src/app/api/finances/stats/route.ts` - обновлен расчет доходов
- `src/app/api/finances/debts/route.ts` - обновлен расчет долгов
- `src/app/api/finances/chart/route.ts` - обновлены диаграммы
- `src/app/api/finances/students/[id]/route.ts` - обновлена логика доступа
- `src/app/api/admin/stats/route.ts` - обновлена админская статистика
